---
title: "correlation"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(psych)
library(rstatix)
```

```{r}
data <- readxl::read_xlsx("Data/params_struc.xlsx") |> 
  mutate(label = factor(label),
         porosity = 1-(BD/2.65),
         Classification = factor(Classification))
```


```{r}
library(ggpubr)
av <- aov(Silt ~ treatment, data = data)
summary(av)
  ggqqplot(data$BD)


TukeyHSD(av)
levene_test(BD ~ treatment, data = data)

```
```{r}
av_porosity <- aov(porosity ~ treatment, data = data)
summary(av_porosity)

TukeyHSD(av_porosity)
```


```{r}
corr_data <- bind_cols(data[,2:8],data[,12:16],data[,21],data[,35:44],data[,46])
corr_data2 <- bind_cols(data[,2:8],data[,12:16],data[,21:34])

```

```{r fig.width=8, fig.height=6}
library(rstatix)
m = cor_mat(corr_data, method = "spearman")
x <- m |> 
  gather(-rowname,key = cor_var, value = r)
# corrplot::corrplot(m, method = "number")
x_filtered <- x |> 
  filter(abs(r) > 0.5)
x |> 
  # filter(abs(r) > 0.5) |> 
  #filter(cor_var == "BD" | rowname == "BD") |> 
  ggplot(aes(rowname, cor_var, fill = r)) + 
  geom_tile(size = 3) +
  labs(x = "variables", y = "variables", title = "Correlation plot")+
  geom_text(aes(label = round(r,2)), size = 2)+
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5),
        axis.text = element_text(size = 10))+
   scale_fill_gradient2(low = "red", high = "blue", mid = "white")
#ggsave("Output/corr_overall.jpg", dpi = 300, width = 9,height = 6)
```

```{r fig.width= 9, fig.height= 6}
dist <- data |> 
  filter(treatment == "Disturbance")
dist_corr <- bind_cols(dist[,2:7],dist[,12:34]) |> 
  cor_mat(method = "spearman") |> 
  gather(-rowname,key = cor_var, value = r)

dist_corr |> 
  ggplot(aes(rowname, cor_var, fill = r)) + 
  geom_tile(size = 2.5) +
  theme_minimal()+
  labs(x = "variables", y = "variables", title = "Correlation plot", subtitle = "Treatment - Disturbance")+
  geom_text(aes(label = round(r,2)), size = 2.2)+
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5),
        axis.text = element_text(size = 11))+
   scale_fill_gradient2(low = "red", high = "blue", mid = "white")

#ggsave("Output/corr_dist.jpg", dpi = 300, width = 9,height = 6)
```

```{r}
control <- data |> 
  filter(treatment == "Control")
control_corr <- bind_cols(control[,2:7],control[,12:34]) |> 
  cor_mat(method = "spearman") |> 
  gather(-rowname,key = cor_var, value = r)

control_corr |> 
  ggplot(aes(rowname, cor_var, fill = r)) + 
  geom_tile(size = 3) +
  theme_minimal()+
  labs(x = "variables", y = "variables", title = "Correlation plot", subtitle = "Treatment: Control")+
  geom_text(aes(label = round(r,2)), size = 2.5)+
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5),
        axis.text = element_text(size = 12))+
   scale_fill_gradient2(low = "red", high = "blue", mid = "white")

#ggsave("Output/corr_control.jpg", dpi = 300, width = 9,height = 6)
```

```{r}
npk <- data |> 
  filter(treatment == "NPK")
npk_corr <- bind_cols(npk[,2:7],npk[,16:29]) |> 
  cor_mat(method = "spearman") |> 
  gather(-rowname,key = cor_var, value = r)

npk_corr |> 
  ggplot(aes(rowname, cor_var, fill = r)) + 
  geom_tile(size = 3) +
  theme_minimal()+
  labs(x = "variables", y = "variables", title = "Correlation plot", subtitle = "Treatment: NPK")+
  geom_text(aes(label = round(r,2)), size = 2.5)+
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5),
        axis.text = element_text(size = 12))+
   scale_fill_gradient2(low = "red", high = "blue", mid = "white")

#ggsave("Output/corr_npk.jpg", dpi = 300, width = 9,height = 6)
  
```

```{r}
npk_dist <- data |> 
  filter(treatment == "NPK+Disturbance")
npk_dist_corr <- bind_cols(npk_dist[,2:7],npk_dist[,16:29]) |> 
  cor_mat(method = "spearman") |> 
  gather(-rowname,key = cor_var, value = r)

npk_dist_corr |> 
   ggplot(aes(rowname, cor_var, fill = r)) + 
  geom_tile(size = 3) +
  theme_minimal()+
  labs(x = "variables", y = "variables", title = "Correlation plot", subtitle = "Treatment: NPK+Disturbance")+
  geom_text(aes(label = round(r,2)), size = 2.5)+
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5),
        axis.text = element_text(size = 10),
        legend.text = element_text(size = 12))+
   scale_fill_gradient2(low = "red", high = "blue", mid = "white")
#ggsave("Output/corr_npk_dist.jpg", dpi = 300, width = 9,height = 6)
  

```

```{r}
data |> 
   #filter(treatment == "Control") |> 
  ggplot(aes(BD,D100))+
  geom_point(aes(color = treatment))+
  geom_smooth(aes(color = treatment),method = "lm", se = F)
```

```{r}
data |> 
  ggplot(aes(BD,Field_Capacity))+
  geom_point(aes(color = treatment))+
  geom_smooth(aes(color = treatment),method = "lm", se = F)
```

```{r}
data |> 
  ggplot(aes(BD,air_capacity))+
  geom_point(aes(color = treatment))+
  geom_smooth(method = "lm", se = F)
```

```{r}
numerical_data <- bind_cols(data[,2:8],data[,12:16],data[,21:24],data[,35:44],data[,46])
```

```{r}
data_normalized <- scale(numerical_data)

data_pca <- prcomp(data_normalized,scale. = T)
summary(data_pca)

```


```{r}
library(FactoMineR)
library(ggcorrplot)
library(factoextra)
fviz_eig(data_pca,addlabels = T)
```

```{r}
fviz_pca_var(data_pca,
             col.var = "contrib",
             repel = TRUE,
             select.var = list(contrib = 10))
```

```{r}
fviz_cos2(data_pca, choice = "var", axes = 1:5)
```

```{r}
fviz_pca_ind(data_pca)
```

```{r}
pca_scores <- data_pca$x |> 
  as.data.frame() |> 
  select(PC1:PC4)
```

```{r}
data_postpca <- data |> 
  bind_cols(pca_scores)
```

```{r}
data |> 
  ggplot(aes(treatment,awc))+
  geom_boxplot()+
  geom_jitter()
```

```{r}
data |> 
  ggplot(aes(BD,Silt))+
  geom_point()
```

